---
- name: Initial configuration
  hosts: ubuntu
  become: true

  tasks:
    - name: Update cache and upgrade all packages
      register: updatesys
      apt:
        name: "*"
        state: latest
        update_cache: yes
        cache_valid_time: 86400 #One day

    - name: Display the last line of the previous task to check the stats
      debug:
        msg:  "{{updatesys.stdout_lines|last}}"

    - name: Configure the PoE HAT fan thresholds
      ansible.builtin.blockinfile:
        path: /boot/firmware/usercfg.txt
        block: |
          # PoE Hat Fan Speeds
          dtoverlay=rpi-poe
          dtparam=poe_fan_temp0=65000
          dtparam=poe_fan_temp1=74000
          dtparam=poe_fan_temp2=76000
          dtparam=poe_fan_temp3=81000
